<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Election 2026 - Cast Your Vote</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
}

.header {
    text-align: center;
    margin-bottom: 40px;
    padding: 40px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    border: 3px solid #d32f2f;
}

h1 {
    color: #333;
    margin-bottom: 10px;
    font-size: 2.8rem;
    background: linear-gradient(135deg, #0c2461 0%, #d32f2f 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.subtitle {
    color: #666;
    font-size: 1.2rem;
    margin-bottom: 20px;
}

.election-badge {
    display: inline-block;
    background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
    color: white;
    padding: 12px 30px;
    border-radius: 25px;
    font-weight: 600;
    margin-top: 10px;
    font-size: 1.1rem;
    box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
}

.status-bar {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 40px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.status-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    transition: all 0.3s ease;
}

.status-item:hover {
    background: #e9ecef;
    transform: translateY(-3px);
}

.status-label {
    color: #666;
    font-size: 0.9rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-label::before {
    font-size: 1rem;
}

.status-value {
    color: #333;
    font-weight: 700;
    font-size: 1.1rem;
}

#accountDisplay::before { content: "üë§ "; }
#networkDisplay::before { content: "üåê "; }
#balanceDisplay::before { content: "üí∞ "; }
#contractDisplay::before { content: "üìÑ "; }

.candidates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
    margin-bottom: 50px;
}

.candidate-card {
    background: white;
    border-radius: 20px;
    padding: 35px;
    text-align: center;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
    border: 4px solid transparent;
}

.candidate-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 8px;
}

.candidate-card:nth-child(1) {
    border-color: #d32f2f;
}

.candidate-card:nth-child(1)::before {
    background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
}

.candidate-card:nth-child(2) {
    border-color: #1976d2;
}

.candidate-card:nth-child(2)::before {
    background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
}

.candidate-card:nth-child(3) {
    border-color: #388e3c;
}

.candidate-card:nth-child(3)::before {
    background: linear-gradient(135deg, #388e3c 0%, #1b5e20 100%);
}

.candidate-card:nth-child(4) {
    border-color: #fbc02d;
}

.candidate-card:nth-child(4)::before {
    background: linear-gradient(135deg, #fbc02d 0%, #f57f17 100%);
}

.candidate-card:hover {
    transform: translateY(-15px) scale(1.02);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
}

.candidate-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    margin: 0 auto 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3.5rem;
    background: white;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border: 5px solid;
}

.candidate-card:nth-child(1) .candidate-avatar {
    border-color: #d32f2f;
    color: #d32f2f;
}

.candidate-card:nth-child(2) .candidate-avatar {
    border-color: #1976d2;
    color: #1976d2;
}

.candidate-card:nth-child(3) .candidate-avatar {
    border-color: #388e3c;
    color: #388e3c;
}

.candidate-card:nth-child(4) .candidate-avatar {
    border-color: #fbc02d;
    color: #fbc02d;
}

.candidate-name {
    font-size: 2rem;
    color: #333;
    margin-bottom: 8px;
    font-weight: 700;
}

.candidate-id {
    color: #666;
    font-size: 1rem;
    margin-bottom: 20px;
    background: #f5f5f5;
    padding: 8px 20px;
    border-radius: 20px;
    display: inline-block;
    font-weight: 600;
}

.candidate-type {
    display: inline-block;
    padding: 6px 15px;
    border-radius: 15px;
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 20px;
}

.party-badge {
    background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
    color: white;
}

.independent-badge {
    background: linear-gradient(135deg, #fbc02d 0%, #f57f17 100%);
    color: white;
}

.candidate-description {
    color: #666;
    margin: 20px 0;
    font-size: 1rem;
    line-height: 1.6;
    min-height: 80px;
}

.vote-btn {
    width: 100%;
    padding: 20px;
    border: none;
    border-radius: 15px;
    font-size: 1.3rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 20px;
    position: relative;
    overflow: hidden;
    letter-spacing: 1px;
}

.vote-btn::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.5);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
}

.vote-btn:focus:not(:active)::after {
    animation: ripple 1s ease-out;
}

@keyframes ripple {
    0% { transform: scale(0, 0); opacity: 0.5; }
    100% { transform: scale(20, 20); opacity: 0; }
}

.vote-btn:nth-child(1) {
    background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
    color: white;
}

.vote-btn:nth-child(2) {
    background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
    color: white;
}

.vote-btn:nth-child(3) {
    background: linear-gradient(135deg, #388e3c 0%, #1b5e20 100%);
    color: white;
}

.vote-btn:nth-child(4) {
    background: linear-gradient(135deg, #fbc02d 0%, #f57f17 100%);
    color: white;
}

.vote-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
}

.vote-btn:disabled {
    background: #cccccc;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
}

.vote-btn.loading::after {
    content: " ‚è≥";
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.status-container {
    background: white;
    border-radius: 20px;
    padding: 40px;
    margin-bottom: 40px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
}

.status-title {
    color: #333;
    margin-bottom: 25px;
    font-size: 1.8rem;
    display: flex;
    align-items: center;
    gap: 15px;
}

.status-title::before {
    content: "üì¢";
    font-size: 2rem;
}

#statusMessage {
    padding: 30px;
    background: #f8f9fa;
    border-radius: 15px;
    min-height: 120px;
    font-size: 1.2rem;
    line-height: 1.8;
    border-left: 5px solid #1976d2;
    transition: all 0.3s ease;
}

#statusMessage.success {
    background: #e8f5e8;
    border-left-color: #388e3c;
}

#statusMessage.error {
    background: #ffebee;
    border-left-color: #d32f2f;
}

#statusMessage.warning {
    background: #fff3e0;
    border-left-color: #fbc02d;
}

#txInfo {
    margin-top: 20px;
    padding: 20px;
    background: #e3f2fd;
    border-radius: 10px;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    word-break: break-all;
    border: 1px solid #bbdefb;
}

.action-buttons {
    display: flex;
    gap: 25px;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 40px;
}

.action-btn {
    padding: 18px 35px;
    border: none;
    border-radius: 15px;
    font-size: 1.2rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 220px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

.back-btn {
    background: linear-gradient(135deg, #616161 0%, #424242 100%);
    color: white;
}

.back-btn:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 25px rgba(0, 0, 0, 0.1);
}

.check-btn {
    background: linear-gradient(135deg, #7b1fa2 0%, #4a148c 100%);
    color: white;
}

.check-btn:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 25px rgba(123, 31, 162, 0.3);
}

.logout-btn {
    background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
    color: white;
}

.logout-btn:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 25px rgba(244, 67, 54, 0.3);
}

.hidden {
    display: none;
}

@media (max-width: 1200px) {
    .candidates-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .candidates-grid {
        grid-template-columns: 1fr;
    }
    
    .status-bar {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .action-btn {
        width: 100%;
    }
    
    h1 {
        font-size: 2.2rem;
    }
    
    .candidate-name {
        font-size: 1.8rem;
    }
}

.watermark {
    text-align: center;
    color: rgba(255, 255, 255, 0.7);
    margin-top: 40px;
    font-size: 0.9rem;
}
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üéì Student Union Election 2026</h1>
        <p class="subtitle">Cast your vote for the future of our campus. Every vote counts!</p>
        <div class="election-badge">üîê Powered by Blockchain Technology</div>
    </div>
    
    <div class="status-bar">
        <div class="status-item">
            <span class="status-label">Your Account</span>
            <span id="accountDisplay" class="status-value">Not connected</span>
        </div>
        <div class="status-item">
            <span class="status-label">Network</span>
            <span id="networkDisplay" class="status-value">Localhost 8545</span>
        </div>
        <div class="status-item">
            <span class="status-label">Your Balance</span>
            <span id="balanceDisplay" class="status-value">0 ETH</span>
        </div>
        <div class="status-item">
            <span class="status-label">Contract Status</span>
            <span id="contractDisplay" class="status-value">Ready</span>
        </div>
    </div>
    
    <div class="candidates-grid">
        <!-- Candidate 1: Akhil Krantikari -->
        <div class="candidate-card">
            <div class="candidate-avatar">üî¥</div>
            <h2 class="candidate-name">Akhil Krantikari</h2>
            <div class="candidate-id">Candidate ID: 1</div>
            <div class="candidate-type party-badge">Political Party</div>
            <p class="candidate-description">
                Fighting for student rights and revolutionary change. Committed to transparent governance 
                and radical reforms in education system.
            </p>
            <button class="vote-btn" onclick="vote(1, 'Akhil Krantikari')">
                ‚úÖ Vote for Akhil Krantikari
            </button>
        </div>
        
        <!-- Candidate 2: ANNFSU -->
        <div class="candidate-card">
            <div class="candidate-avatar">üîµ</div>
            <h2 class="candidate-name">ANNFSU</h2>
            <div class="candidate-id">Candidate ID: 2</div>
            <div class="candidate-type party-badge">Student Union</div>
            <p class="candidate-description">
                All Nepal National Free Students Union. Advocating for democratic values, 
                educational reforms, and student welfare initiatives across campuses.
            </p>
            <button class="vote-btn" onclick="vote(2, 'ANNFSU')">
                ‚úÖ Vote for ANNFSU
            </button>
        </div>
        
        <!-- Candidate 3: NSU -->
        <div class="candidate-card">
            <div class="candidate-avatar">üü¢</div>
            <h2 class="candidate-name">NSU</h2>
            <div class="candidate-id">Candidate ID: 3</div>
            <div class="candidate-type party-badge">Student Union</div>
            <p class="candidate-description">
                Nepal Students Union. Focused on quality education, campus infrastructure, 
                and creating opportunities for student entrepreneurship and innovation.
            </p>
            <button class="vote-btn" onclick="vote(3, 'NSU')">
                ‚úÖ Vote for NSU
            </button>
        </div>
        
        <!-- Candidate 4: Independent -->
        <div class="candidate-card">
            <div class="candidate-avatar">üü°</div>
            <h2 class="candidate-name">Independent</h2>
            <div class="candidate-id">Candidate ID: 4</div>
            <div class="candidate-type independent-badge">Independent Candidate</div>
            <p class="candidate-description">
                Free from party politics. Committed to practical solutions, unbiased leadership, 
                and representing all students regardless of political affiliation.
            </p>
            <button class="vote-btn" onclick="vote(4, 'Independent')">
                ‚úÖ Vote for Independent
            </button>
        </div>
    </div>
    
    <div class="status-container">
        <h3 class="status-title">Voting Status & Transaction Information</h3>
        <div id="statusMessage">
            üîó Connected to voting system. Select a candidate to cast your vote.<br>
            <small>Remember: You can only vote once per election!</small>
        </div>
        <div id="txInfo" class="hidden"></div>
    </div>
    
    <div class="action-buttons">
        <button class="action-btn back-btn" onclick="window.location.href='index.html'">
            ‚Üê Back to Home
        </button>
        <button class="action-btn check-btn" onclick="checkVotingStatus()">
            üîç Check My Voting Status
        </button>
        <button class="action-btn logout-btn" onclick="logout()">
            üö™ Logout
        </button>
    </div>
    
    <div class="watermark">
        <p>üìä Secure Blockchain Voting System | Each vote is encrypted and immutable</p>
    </div>
</div>

<script>
// ========== LOGIN CHECK ==========
window.addEventListener('load', function() {
    const isLoggedIn = sessionStorage.getItem('isLoggedIn');
    const walletConnected = sessionStorage.getItem('walletConnected');
    
    if (!isLoggedIn || isLoggedIn !== 'true') {
        alert("‚ö†Ô∏è Please login first!");
        window.location.href = "login.html";
        return;
    }
    
    if (!walletConnected || walletConnected !== 'true') {
        alert("‚ö†Ô∏è Please connect your wallet first!");
        window.location.href = "login.html";
        return;
    }
    
    // Get username from session storage
    const username = sessionStorage.getItem('username') || 'Student';
    const account = sessionStorage.getItem('account');
    
    console.log(`Welcome ${username}! Ready to vote.`);
    
    // Update UI to show logged in user
    const accountDisplay = document.getElementById('accountDisplay');
    if (accountDisplay && account) {
        function formatAddress(addr) {
            return `${addr.substring(0, 6)}...${addr.substring(addr.length - 4)}`;
        }
        accountDisplay.textContent = `${username} (${formatAddress(account)})`;
    }
});
// ========== END LOGIN CHECK ==========

// Configuration
const CONFIG = {
    CONTRACT_ADDRESS: "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512",
    ADMIN_ADDRESS: "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
    NETWORK: {
        chainId: "0x7A69"
    },
    CANDIDATES: {
        1: { name: "Akhil Krantikari", symbol: "üî¥", type: "party" },
        2: { name: "ANNFSU", symbol: "üîµ", type: "student_union" },
        3: { name: "NSU", symbol: "üü¢", type: "student_union" },
        4: { name: "Independent", symbol: "üü°", type: "independent" }
    }
};

// State
let currentAccount = null;
let userBalance = "0";

// DOM Elements
const statusMessage = document.getElementById('statusMessage');
const txInfo = document.getElementById('txInfo');
const accountDisplay = document.getElementById('accountDisplay');
const balanceDisplay = document.getElementById('balanceDisplay');
const contractDisplay = document.getElementById('contractDisplay');
const networkDisplay = document.getElementById('networkDisplay');
const voteButtons = document.querySelectorAll('.vote-btn');

// Function selector for vote(uint256 candidateId)
// keccak256("vote(uint256)") = 0x5b7f415c
function createVoteData(candidateId) {
    const selector = "5b7f415c";
    const candidateIdHex = BigInt(candidateId).toString(16).padStart(64, '0');
    return "0x" + selector + candidateIdHex;
}

// Format address
function formatAddress(address) {
    return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
}

// Format balance
function formatBalance(balanceWei) {
    const balanceEth = parseInt(balanceWei) / 1e18;
    return `${balanceEth.toFixed(4)} ETH`;
}

// Update status display
function updateStatus(message, type = "info") {
    statusMessage.innerHTML = message;
    statusMessage.className = "";
    
    switch(type) {
        case "success":
            statusMessage.classList.add("success");
            break;
        case "error":
            statusMessage.classList.add("error");
            break;
        case "warning":
            statusMessage.classList.add("warning");
            break;
        default:
            statusMessage.style.borderLeft = "5px solid #1976d2";
    }
}

// Update transaction info display
function updateTxInfo(txHash) {
    if (!txHash) {
        txInfo.classList.add("hidden");
        return;
    }
    
    txInfo.innerHTML = `
        <strong>üìù Transaction Details:</strong><br>
        <strong>Hash:</strong> ${txHash}<br>
        <strong>Status:</strong> Processing...<br>
        <strong>Network:</strong> Hardhat Localhost<br>
        <small>This transaction is secured by blockchain technology</small>
    `;
    txInfo.classList.remove("hidden");
}

// Connect to MetaMask
async function connectWallet() {
    if (!window.ethereum) {
        updateStatus("‚ùå MetaMask not detected! Please install MetaMask from metamask.io", "error");
        return false;
    }
    
    try {
        updateStatus("üîÑ Connecting to MetaMask wallet...", "warning");
        
        // Switch to localhost network
        await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: CONFIG.NETWORK.chainId }]
        });
        
        // Request accounts
        const accounts = await window.ethereum.request({ 
            method: 'eth_requestAccounts' 
        });
        
        if (!accounts || accounts.length === 0) {
            throw new Error("No accounts found. Please unlock MetaMask.");
        }
        
        currentAccount = accounts[0];
        
        // Get balance
        userBalance = await window.ethereum.request({
            method: 'eth_getBalance',
            params: [currentAccount, 'latest']
        });
        
        // Update UI
        accountDisplay.textContent = formatAddress(currentAccount);
        balanceDisplay.textContent = formatBalance(userBalance);
        networkDisplay.textContent = "Hardhat Localhost ‚úÖ";
        contractDisplay.textContent = "Ready ‚úÖ";
        
        updateStatus(
            `‚úÖ <strong>Wallet Connected Successfully!</strong><br>
            üë§ Account: ${formatAddress(currentAccount)}<br>
            üí∞ Balance: ${formatBalance(userBalance)}<br>
            üó≥Ô∏è You can now vote for any candidate`,
            "success"
        );
        
        return true;
        
    } catch (error) {
        console.error("Connection error:", error);
        
        let errorMsg = "Failed to connect to MetaMask.";
        if (error.code === 4001) {
            errorMsg = "‚ùå Connection rejected by user. Please connect your wallet to vote.";
        } else if (error.message.includes("already pending")) {
            errorMsg = "‚ö†Ô∏è Connection request already pending. Please check MetaMask.";
        }
        
        updateStatus(errorMsg, "error");
        return false;
    }
}

// Main vote function
async function vote(candidateId, candidateName) {
    console.log(`Voting for ${candidateName} (ID: ${candidateId})`);
    
    const candidate = CONFIG.CANDIDATES[candidateId];
    const candidateSymbol = candidate ? candidate.symbol : "üéØ";
    
    // Disable all vote buttons during transaction
    voteButtons.forEach(btn => {
        btn.disabled = true;
        btn.classList.add("loading");
    });
    
    // Connect first if needed
    if (!currentAccount) {
        const connected = await connectWallet();
        if (!connected) {
            voteButtons.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove("loading");
            });
            return;
        }
    }
    
    try {
        updateStatus(
            `üó≥Ô∏è <strong>Voting for ${candidateSymbol} ${candidateName}</strong><br>
            ‚è≥ Please check MetaMask to confirm your vote...<br>
            <small>This may take a few seconds</small>`,
            "warning"
        );
        
        // Create transaction data
        const data = createVoteData(candidateId);
        console.log("Transaction data:", data);
        
        // Send transaction
        const txHash = await window.ethereum.request({
            method: 'eth_sendTransaction',
            params: [{
                from: currentAccount,
                to: CONFIG.CONTRACT_ADDRESS,
                data: data,
                gas: '0x30d40', // 200,000 gas
                gasPrice: '0x2540be400' // 10 gwei
            }]
        });
        
        console.log("Transaction sent:", txHash);
        updateTxInfo(txHash);
        
        updateStatus(
            `‚úÖ <strong>Vote Submitted!</strong><br>
            üìù Transaction: ${txHash.substring(0, 12)}...<br>
            ‚è≥ Waiting for blockchain confirmation...`,
            "warning"
        );
        
        // Wait for transaction receipt
        const receipt = await waitForTransaction(txHash);
        
        if (receipt && receipt.status === '0x1') {
            updateStatus(
                `üéâ <strong>Congratulations!</strong><br>
                You have successfully voted for <strong>${candidateSymbol} ${candidateName}</strong>!<br>
                ‚úÖ Transaction confirmed in block #${parseInt(receipt.blockNumber)}<br>
                üîí Your vote is now permanently recorded on the blockchain`,
                "success"
            );
            
            // Update balance after voting
            userBalance = await window.ethereum.request({
                method: 'eth_getBalance',
                params: [currentAccount, 'latest']
            });
            balanceDisplay.textContent = formatBalance(userBalance);
            
            // Hide transaction info after success
            setTimeout(() => {
                txInfo.classList.add("hidden");
            }, 5000);
            
        } else {
            updateStatus("‚ùå Transaction failed or was reverted. Please try again.", "error");
        }
        
    } catch (error) {
        console.error("Vote error:", error);
        
        let errorMsg = error.message;
        if (error.code === 4001) {
            errorMsg = "‚ùå Transaction rejected by user. Your vote was not cast.";
        } else if (error.message.includes("already voted")) {
            errorMsg = "‚ùå You have already voted in this election! Each address can only vote once.";
        } else if (error.message.includes("Invalid candidate")) {
            errorMsg = "‚ùå Invalid candidate ID. Please select a valid candidate.";
        } else if (error.message.includes("revert")) {
            errorMsg = "‚ùå Transaction failed. You may have already voted or there's an issue with the contract.";
        } else if (error.message.includes("insufficient funds")) {
            errorMsg = "‚ùå Insufficient ETH for gas. You need more ETH to complete this transaction.";
        }
        
        updateStatus(errorMsg, "error");
        
    } finally {
        // Re-enable buttons
        voteButtons.forEach(btn => {
            btn.disabled = false;
            btn.classList.remove("loading");
        });
    }
}

// Wait for transaction confirmation
async function waitForTransaction(txHash, maxAttempts = 30) {
    for (let i = 0; i < maxAttempts; i++) {
        try {
            const receipt = await window.ethereum.request({
                method: 'eth_getTransactionReceipt',
                params: [txHash]
            });
            
            if (receipt) {
                console.log("Transaction mined:", receipt);
                return receipt;
            }
            
            // Update waiting status every 5 seconds
            if (i % 5 === 0) {
                const dots = '.'.repeat(Math.floor(i / 5) % 4 + 1);
                statusMessage.innerHTML = statusMessage.innerHTML.replace(/Waiting[.]*/g, `Waiting${dots}`);
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
        } catch (error) {
            console.error("Error checking receipt:", error);
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }
    
    throw new Error("Transaction timeout after 30 seconds");
}

// Check voting status
async function checkVotingStatus() {
    if (!currentAccount) {
        const connected = await connectWallet();
        if (!connected) return;
    }
    
    try {
        updateStatus("üîç Checking your voting status...", "warning");
        
        // Try to call vote to see if it reverts (hacky way to check if already voted)
        const testData = createVoteData(1);
        
        try {
            await window.ethereum.request({
                method: 'eth_call',
                params: [{
                    from: currentAccount,
                    to: CONFIG.CONTRACT_ADDRESS,
                    data: testData
                }, 'latest']
            });
            
            updateStatus(
                `‚úÖ <strong>You have NOT voted yet!</strong><br>
                You are eligible to vote for any of the 4 candidates.<br>
                üéØ Please select your preferred candidate above.`,
                "success"
            );
            
        } catch (error) {
            if (error.message.includes("already voted")) {
                updateStatus(
                    `‚ö†Ô∏è <strong>You have ALREADY VOTED!</strong><br>
                    Each address can only vote once in this election.<br>
                    üîí Your vote is secured on the blockchain.`,
                    "warning"
                );
            } else {
                updateStatus(
                    `‚ùì Unable to determine voting status.<br>
                    Error: ${error.message.substring(0, 100)}...`,
                    "error"
                );
            }
        }
        
    } catch (error) {
        updateStatus(`‚ùå Error checking status: ${error.message}`, "error");
    }
}

// Logout function
function logout() {
    if (confirm("Are you sure you want to logout?")) {
        // Clear all session storage
        sessionStorage.clear();
        
        // Show logout message
        updateStatus("üîí Logging out... Redirecting to login page.", "warning");
        
        // Redirect to login after delay
        setTimeout(() => {
            window.location.href = "login.html";
        }, 1000);
    }
}

// Initialize on page load
window.addEventListener('load', async () => {
    if (window.ethereum) {
        try {
            // Check if already connected
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts && accounts.length > 0) {
                currentAccount = accounts[0];
                userBalance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [currentAccount, 'latest']
                });
                
                // Update UI
                accountDisplay.textContent = formatAddress(currentAccount);
                balanceDisplay.textContent = formatBalance(userBalance);
                networkDisplay.textContent = "Hardhat Localhost ‚úÖ";
                contractDisplay.textContent = "Ready ‚úÖ";
                
                updateStatus(
                    `‚úÖ <strong>Wallet Connected</strong><br>
                    üë§ ${formatAddress(currentAccount)}<br>
                    üí∞ ${formatBalance(userBalance)}<br>
                    üó≥Ô∏è Select a candidate to vote!`,
                    "success"
                );
            }
        } catch (error) {
            console.log("Not auto-connected:", error);
        }
        
        // Listen for account changes
        window.ethereum.on('accountsChanged', (accounts) => {
            if (accounts && accounts.length > 0) {
                currentAccount = accounts[0];
                accountDisplay.textContent = formatAddress(currentAccount);
                updateStatus("üîÑ Account changed. Please refresh the page for accurate voting status.", "warning");
            } else {
                currentAccount = null;
                accountDisplay.textContent = "Not connected";
                updateStatus("üîå Disconnected from wallet. Please reconnect to vote.", "error");
            }
        });
        
        // Listen for network changes
        window.ethereum.on('chainChanged', () => {
            window.location.reload();
        });
        
    } else {
        updateStatus(
            "‚ùå MetaMask not detected!<br>" +
            "Please install <a href='https://metamask.io/' target='_blank' style='color: #1976d2; font-weight: bold;'>MetaMask</a> to participate in the election.<br>" +
            "Then refresh this page and connect your wallet.",
            "error"
        );
    }
});

// Add click handlers to all vote buttons (for better error handling)
document.querySelectorAll('.vote-btn').forEach((btn, index) => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        const candidateId = index + 1;
        const candidateName = CONFIG.CANDIDATES[candidateId]?.name || `Candidate ${candidateId}`;
        vote(candidateId, candidateName);
    });
});
</script>
</body>
</html>